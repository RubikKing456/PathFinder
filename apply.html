<!DOCTYPE html>
x <html>
<head>
  <title>Apply for Opportunity</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script> 
</head>

<body style="background: #0b0f14; color: white; font-family: 'Inter', sans-serif; margin: 0;">
   <nav>
  <a href="studentdashboard.html" class="nav-logo">PathFinder</a>
  
  <div class="nav-links">
    <a href="studentdashboard.html" class="nav-item">Browse</a>
    <a href="myapplication.html" class="nav-item">My Applications</a>
    <a href="messages.html" class="nav-item">Messages</a>
  </div>

  <div class="nav-right">
    <div class="user-pill">
      <span id="user-name-display">Loading...</span>
      <div class="avatar-circle" id="user-initial">?</div>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</nav>

  <style>
  :root { 
    --bg: #0b0f14; 
    --card: #111827; 
    --accent: #facc15; 
    --text-secondary: #9ca3af;
  }

  body { 
    background: var(--bg); 
    color: white; 
    font-family: 'Inter', sans-serif; 
    margin: 0; 
  }

  /* Navigation Bar Styling */
  nav {
    background: var(--card);
    padding: 0 60px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    height: 70px;
  }

  .nav-logo {
    font-weight: 700; 
    color: var(--accent); 
    font-size: 20px;
    text-decoration: none;
  }

  .nav-links { 
    display: flex; 
    gap: 30px; 
  }

  .nav-item { 
    text-decoration: none;
    color: var(--text-secondary); 
    font-size: 14px; 
    font-weight: 500; 
    transition: 0.3s; 
    cursor: pointer;
  }

  .nav-item:hover { 
    color: var(--accent); 
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .user-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    color: white;
    font-size: 14px;
  }

  .avatar-circle {
    width: 32px;
    height: 32px;
    background: var(--accent);
    border-radius: 50%;
    color: black;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .logout-btn {
    background: transparent;
    border: 1px solid #ef4444;
    color: #ef4444;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: 0.2s;
  }

  .logout-btn:hover {
    background: #ef4444;
    color: white;
  }
</style>
  <div style="display: flex; min-height: 100vh; padding: 40px; gap: 30px; box-sizing: border-box;">

    
    <div style="flex: 1; background: #111827; padding: 30px; border-radius: 16px; border: 1px solid #1f2937; height: fit-content;">
      <a href="studentdashboard.html" style="color: #9ca3af; text-decoration: none; font-size: 14px;">‚Üê Back to Opportunities</a>
      
      <div style="margin-top: 20px;">
        <span id="oppTags" style="display: flex; gap: 8px; margin-bottom: 15px;"></span>
        <h1 id="oppTitle" style="font-size: 32px; margin: 0 0 10px 0;">Loading...</h1>
        <p id="oppCompany" style="color: #9ca3af; font-size: 18px; margin-bottom: 25px;">...</p>
        
        <div id="oppMeta" style="display: flex; gap: 20px; color: #facc15; font-size: 14px; margin-bottom: 30px;">
           </div>

        <h3 style="border-top: 1px solid #1f2937; padding-top: 25px;">About This Opportunity</h3>
        <p id="oppDesc" style="color: #d1d5db; line-height: 1.6;">...</p>

        <h3 style="margin-top: 30px;">Requirements</h3>
        <p id="oppReqs" style="color: #d1d5db;">...</p>
      </div>
    </div>

    <div style="width: 450px; background: #111827; padding: 30px; border-radius: 16px; border: 1px solid #1f2937; height: fit-content; position: sticky; top: 40px;">
      <h2 style="margin-top: 0; color: #facc15;">Complete Application</h2>
      
      <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 20px;">
        <div style="background: #0b0f14; padding: 15px; border-radius: 8px; border-left: 4px solid #facc15;">
            <p style="margin: 0; font-size: 14px;"><strong>Applicant:</strong> <span id="studentName">...</span></p>
            <p style="margin: 5px 0 0 0; font-size: 14px;"><strong>Grade:</strong> <span id="studentGrade">...</span></p>
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #9ca3af;">Why do you deserve this role?</label>
          <textarea id="q1" rows="4" style="width: 100%; background: #0b0f14; border: 1px solid #374151; color: white; border-radius: 8px; padding: 12px; box-sizing: border-box;"></textarea>
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #9ca3af;">Why are you interested?</label>
          <textarea id="q2" rows="4" style="width: 100%; background: #0b0f14; border: 1px solid #374151; color: white; border-radius: 8px; padding: 12px; box-sizing: border-box;"></textarea>
        </div>

        <div>
          <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #9ca3af;">CV/Portfolio Link</label>
          <input type="url" id="cvLink" placeholder="Google Drive or Canva link" style="width: 100%; background: #0b0f14; border: 1px solid #374151; color: white; border-radius: 8px; padding: 12px; box-sizing: border-box;">
        </div>

        <button onclick="submitApplication()" style="background: #facc15; color: #111827; border: none; padding: 15px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px;">Submit Application</button>
      </div>
    </div>

  </div>

<script>
  // 1. Initialize Firebase (Ensure your config is here)
  var firebaseConfig = { 
    apiKey: "AIzaSyA90OItrHTEjBD13jm-yk2bo3ljKwLbe3k",
    authDomain: "eportfolio-8af75.firebaseapp.com",
    projectId: "eportfolio-8af75"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  firebase.auth().onAuthStateChanged(user => {
  if (user) {
    db.collection("users").doc(user.uid).get().then(doc => {
      if (doc.exists) {
        const name = doc.data().name;
        document.getElementById('user-name-display').innerText = name;
        document.getElementById('user-initial').innerText = name.charAt(0).toUpperCase();
      }
    });
  } else {
    window.location.href = "login.html";
  }
});

function logout() {
  firebase.auth().signOut().then(() => {
    window.location.href = "login.html";
  });
}
  const urlParams = new URLSearchParams(window.location.search);
  const oppId = urlParams.get('id');
  let postedBy = ""; // We will fill this once the data loads

  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      db.collection("users").doc(user.uid).get().then(doc => {
        const u = doc.data();
        document.getElementById('studentName').innerText = u.name;
        document.getElementById('studentGrade').innerText = u.grade || "N/A";
      });
      if (oppId) {
        db.collection("opportunities").doc(oppId).get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            postedBy = data.postedBy; // Vital for sending the app to the right parent
            
            // Updating the HTML elements on the left side
            document.getElementById('oppTitle').innerText = data.title;
            document.getElementById('oppCompany').innerText = data.company;
            document.getElementById('oppDesc').innerText = data.description;
            document.getElementById('oppReqs').innerText = data.requirements;
            document.getElementById('oppReqs').innerText = data.requirements || "No specific requirements listed.";
            
            // Populate meta-data icons (Location, Spots, etc.)
            const meta = document.getElementById('oppMeta');
            meta.innerHTML = `
              <span>üìç ${data.location || 'Remote'}</span>
              <span>üë• ${data.spots || '1'} spots available</span>
            `;

            // Adding the colored tags at the top
            const tags = document.getElementById('oppTags');
            if(data.type) {
              tags.innerHTML = `<span style="background:#facc1520; color:#facc15; padding:4px 12px; border-radius:20px; font-size:12px;">${data.type}</span>`;
            }
          }
        });
      }
    } else {
      window.location.href = "login.html";
    }
  });

  // 5. THE SUBMIT FUNCTION: Triggered when the button is clicked
  function submitApplication() {
    const user = firebase.auth().currentUser;
    
    // Check if the opportunity data actually loaded first
    if (!postedBy) {
        alert("The opportunity data is still loading. Please wait a second and try again.");
        return;
    }

    const q1Value = document.getElementById('q1').value;
    const q2Value = document.getElementById('q2').value;
    const linkValue = document.getElementById('cvLink').value;

    if(!q1Value || !q2Value || !linkValue) {
      alert("Please fill in all fields before submitting.");
      return;
    }

    // This console log will help you see if there is an error in the browser console
    console.log("Attempting to submit for Parent:", postedBy);

    db.collection("applications").add({
        opportunityId: oppId,
        opportunityTitle: document.getElementById('oppTitle').innerText,
        studentId: user.uid,
        studentName: document.getElementById('studentName').innerText,
        studentGrade: document.getElementById('studentGrade').innerText,
        parentId: postedBy, 
        q1: q1Value,
        q2: q2Value,
        cvUrl: linkValue,
        status: "Pending",
        appliedAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        alert("Application Submitted!");
        window.location.href = "studentdashboard.html";
    }).catch((error) => {
        console.error("Error submitting application: ", error);
        alert("Submission failed: " + error.message);
    });
}
</script>
</body>

</html>
